<script>
  const REDIRECT_URL = 'https://kleiber.ru/cheesecase?utm_source=qr&utm_medium=redirect&utm_campaign=cheesecase_talk';
  const SCRIPT_URL   = 'https://script.google.com/macros/s/AKfycbwgeklAGvalBy15AyhSyeG2pDsowg_mkm8H1Z4x0QB6-7zS6DHp3pWm6W88v6xzc0uT/exec';
  const DEFAULT_CODE = 'cheesecase_qr';

  function getAllParams() {
    const out = {};
    const q = new URLSearchParams(window.location.search);
    for (const [k, v] of q.entries()) out[k] = v;
    return out;
  }

  function buildPingUrl() {
    const params = getAllParams();
    if (!params.id && !params.code) params.id = DEFAULT_CODE;
    params.ping = '1';
    params.ref = document.referrer || '';
    params.ua = navigator.userAgent || '';
    params.hitId = String(Date.now()) + '-' + Math.random().toString(36).slice(2, 10); // уникальный id
    sessionStorage.setItem('hitId', params.hitId); // чтобы сервер мог видеть
    const usp = new URLSearchParams(params);
    return SCRIPT_URL + '?' + usp.toString();
  }

  function sendPingOnce(url) {
    if (sessionStorage.getItem('redirectPingSent') === '1') return; // защита от повторов в этой сессии
    sessionStorage.setItem('redirectPingSent', '1');

    // Выбираем ОДИН транспорт: sendBeacon > fetch > img
    if (navigator.sendBeacon) {
      const blob = new Blob([], { type: 'text/plain' });
      navigator.sendBeacon(url, blob);
      return;
    }
    if (window.fetch) {
      fetch(url, { method: 'GET', mode: 'no-cors', keepalive: true }).catch(()=>{});
      return;
    }
    const img = new Image();
    img.referrerPolicy = 'no-referrer';
    img.src = url;
  }

  function redirectNow() {
    try {
      window.location.href = REDIRECT_URL;
    } catch (_) {
      try { window.location.replace(REDIRECT_URL); }
      catch (_) {
        const a = document.getElementById('manualLink');
        if (a) a.click();
      }
    }
  }

  (function main() {
    const pingUrl = buildPingUrl();
    sendPingOnce(pingUrl);
    setTimeout(redirectNow, 800);
    setTimeout(redirectNow, 3000); // бэкап
  })();
</script>
